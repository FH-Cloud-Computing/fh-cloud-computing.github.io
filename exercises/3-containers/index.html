
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Course material for the Cloud Computing course of Fall 2020 at the FH Campus Wien. This course goes through the theory and practice of implementing applications for the cloud." name="description"/>
<link href="../../favicon.svg" rel="shortcut icon"/>
<meta content="mkdocs-1.1.2, mkdocs-material-6.1.4" name="generator"/>
<title>3. Containers - Cloud Computing 2020</title>
<link href="../../assets/stylesheets/main.358818c7.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.f0267088.min.css" rel="stylesheet"/>
<link href="../../custom.css" rel="stylesheet"/>
<meta content="website" property="og:type">
<meta content="Cloud Computing 2020" name="title" property="og:title">
<meta content="Cloud Computing 2020" property="og:site_name ">
<meta content="Course material for the Cloud Computing course of Fall 2020 at the FH Campus Wien. This course goes through the theory and practice of implementing applications for the cloud." name="description" property="og:description">
<meta content="None" property="og:url"/>
<meta content="social.png" name="image" property="og:image"/>
<meta content="Janos Pasztor, Peter Wenzl, GÃ¼nther Pospischil" name="author"/>
<meta content="summary_large_image" name="twitter:card">
<meta content="Cloud Computing 2020 | Cloud Computing 2020" name="twitter:title"/>
<meta content="Course material for the Cloud Computing course of Fall 2020 at the FH Campus Wien. This course goes through the theory and practice of implementing applications for the cloud." name="twitter:description"/>
<meta content="social.png" name="twitter:image"/>
<meta content="2020-09-14" name="date"/>
</meta></meta></meta></meta></meta></head>
<body data-md-color-accent="none" data-md-color-primary="none" data-md-color-scheme="" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#installing_docker">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header-nav md-grid">
<a aria-label="Cloud Computing 2020" class="md-header-nav__button md-logo" href="../.." title="Cloud Computing 2020">
<img alt="logo" src="../../logo-wide.svg"/>
</a>
<label class="md-header-nav__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header-nav__title" data-md-component="header-title">
<div class="md-header-nav__ellipsis">
<span class="md-header-nav__topic md-ellipsis">
            Cloud Computing 2020
          </span>
<span class="md-header-nav__topic md-ellipsis">
            
              3. Containers
            
          </span>
</div>
</div>
<label class="md-header-nav__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" data-md-state="active" name="query" placeholder="Search" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</label>
<button aria-label="Clear" class="md-search__icon md-icon" data-md-component="search-reset" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header-nav__source">
<a class="md-source" href="https://github.com/fh-cloud-computing/website/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs md-tabs--active" data-md-component="tabs">
<div class="md-tabs__inner md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
          About the course
        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../lectures/">
          Lectures
        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link md-tabs__link--active" href="../">
          Exercises
        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../glossary/">
          Glossary
        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Cloud Computing 2020" class="md-nav__button md-logo" href="../.." title="Cloud Computing 2020">
<img alt="logo" src="../../logo-wide.svg"/>
</a>
    Cloud Computing 2020
  </label>
<div class="md-nav__source">
<a class="md-source" href="https://github.com/fh-cloud-computing/website/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" id="nav-1" type="checkbox"/>
<label class="md-nav__link" for="nav-1">
      About the course
      <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="About the course" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-1">
<span class="md-nav__icon md-icon"></span>
        About the course
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
      Overview
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../grading/">
      Grading
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../projectwork/">
      Project work
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../deadlines/">
      Deadlines
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../testing/">
      Testing
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../help/">
      Getting help
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" id="nav-2" type="checkbox"/>
<label class="md-nav__link" for="nav-2">
      Lectures
      <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Lectures" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-2">
<span class="md-nav__icon md-icon"></span>
        Lectures
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../lectures/">
      Overview
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../lectures/1-cloud-intro/">
      1. Introduction to the Cloud
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../lectures/2-iaas/">
      2. Infrastructure as a Service
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../lectures/3-xaas/">
      3. Beyond IaaS
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../lectures/4-containers/">
      4. Containers
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../lectures/5-cloud-native/">
      5. Cloud-native software development
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="nav-3" id="nav-3" type="checkbox"/>
<label class="md-nav__link" for="nav-3">
      Exercises
      <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Exercises" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-3">
<span class="md-nav__icon md-icon"></span>
        Exercises
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
      Overview
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../1-iaas/">
      1. IaaS
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../2-terraform/">
      2. Terraform
    </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
        3. Containers
        <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
      3. Containers
    </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#installing_docker">
    Installing Docker
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#creating_a_basic_dockerfile">
    Creating a basic Dockerfile
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#a_word_about_cmd">
    A word about CMD
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#getting_nginx_running">
    Getting nginx running
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#applying_configuration_files">
    Applying configuration files
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#building_a_software_in_a_container">
    Building a software in a container
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#service_discovery">
    Service discovery
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#volumes">
    Volumes
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#security_hardening">
    Security hardening
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../4-prometheus/">
      4. Prometheus
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../5-grafana/">
      5. Grafana
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../6-api-integration/">
      6. API integration
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" id="nav-4" type="checkbox"/>
<label class="md-nav__link" for="nav-4">
      Glossary
      <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Glossary" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-4">
<span class="md-nav__icon md-icon"></span>
        Glossary
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../glossary/">
      A-Z
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#installing_docker">
    Installing Docker
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#creating_a_basic_dockerfile">
    Creating a basic Dockerfile
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#a_word_about_cmd">
    A word about CMD
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#getting_nginx_running">
    Getting nginx running
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#applying_configuration_files">
    Applying configuration files
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#building_a_software_in_a_container">
    Building a software in a container
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#service_discovery">
    Service discovery
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#volumes">
    Volumes
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#security_hardening">
    Security hardening
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/fh-cloud-computing/website/edit/master/docs/exercises/3-containers/index.md" title="Edit this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"></path></svg>
</a>
<div class="download"><a download href="index.pdf"><button>Download PDF ð¨ï¸</button></a>
</div>
<h1>Containers</h1>
<p>As described in <a href="../../lectures/4-containers/">lecture 4</a> containers are a staple of packaging applications in a self-contained fashion. Linux containers contain everything a Linux application needs to run on a Linux kernel in an isolated fashion. This exercise will run you through the basics of packaging an application in a container and running it on a Linux server.</p>
<p>This guide is an abridged version of <a href="https://pasztor.at/blog/docker-for-beginners/">âGetting started with Docker for the Inquisitive Mindâ</a> by Janos Pasztor, one of the lecturers on this course. We highly recommend reading the original version for more detail.</p>
<h3 id="installing_docker">Installing Docker<a class="headerlink" href="#installing_docker" title="Permanent link">#</a></h3>
<p>One of the most popular small-scale container runtimes, and indeed the first to popularize build recipes is <a href="https://www.docker.com/">Docker</a>. Docker can be installed on Linux as well as Windows and MacOS, but the latter two have several issues a user needs to work around so we recommend using an Ubuntu Linux 20.04 virtual machine for the purposes of this exercise.</p>
<p>To install Docker you can either follow the <a href="https://docs.docker.com/engine/install/ubuntu/">installation guide</a> or use the <a href="https://docs.docker.com/engine/install/ubuntu/#install-using-the-convenience-script">convenience script</a> to do so:</p>
<div class="highlight"><pre><span></span><code>curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
</code></pre></div>
<p>Please note that this script is not recommended for production use, but will be accepted in a solution to the <a href="../../projectwork/">project work</a>.</p>
<h3 id="creating_a_basic_dockerfile">Creating a basic Dockerfile<a class="headerlink" href="#creating_a_basic_dockerfile" title="Permanent link">#</a></h3>
<p>In order to package an application you can create a <code>Dockerfile</code> containing the instructions to install the dependencies and package an application. This file consists of the following format:</p>
<div class="highlight"><pre><span></span><code>COMMAND PARAMETERS
</code></pre></div>
<p>The first command is the <code>FROM</code> command. This command specifies which base image to use, for example:</p>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span> <span class="s">ubuntu:20.04</span>
</code></pre></div>
<p>As mentioned before, containers are not virtual machines. This command only pulls in the userland piece of an Ubuntu system. It can be used to install libraries and packages required for an application to run.</p>
<p>As this file has now been created we can build our container image as follows:</p>
<div class="highlight"><pre><span></span><code>docker build -t myimagename .
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The dot at the end is important! It tells Docker to look for the Dockerfile in the current directory.</p>
</div>
<p>Now that the image is built it can be launched:</p>
<div class="highlight"><pre><span></span><code>docker run -ti myimagename
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The <code>-ti</code> parameter is only required for interactive sessions. For non-interactive sessions it is not required.</p>
</div>
<p>Inside the container you can do operations just as you normally would. For example, you could run <code>apt update</code>, then <code>apt install mc</code>, and finally <code>mc</code> to launch the midnight commander. Once you are finished with the interactive session you can use the <code>exit</code> command or <kbd>Ctrl</kbd> + <kbd>D</kbd> to exit.</p>
<p>However, as discussed in <a href="../../lectures/4-containers/">lecture 4</a> the main benefit containers bring to the table is reusability. If you treat a container like you would treat a virtual machine, updating, installing things manually, you lose the main benefit of using containers.</p>
<p>Let's extend our <code>Dockerfile</code> to install the <code>nginx</code> webserver:</p>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span> <span class="s">ubuntu:20.04</span>

<span class="k">ENV</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive

<span class="k">RUN</span> apt update
<span class="k">RUN</span> apt install nginx
</code></pre></div>
<p>There are two new commands here: the <code>ENV</code> and the <code>RUN</code> command. The <code>ENV</code> command instructs Docker to set an environment variable. The <code>DEBIAN_FRONTEND=noninteractive</code> environment variable instructs the <code>apt</code> and <code>dpkg</code> packaging utilities in Ubuntu to run in non-interactive mode and not ask questions. Instead, these commands will use default values. The <code>RUN</code> command simply runs the specified command.</p>
<p>If you run the <code>docker build .</code> command now the build will fail:</p>
<div class="highlight"><pre><span></span><code>...
After this operation, 60.8 MB of additional disk space will be used.
Do you want to continue? [Y/n] Abort.
The command '/bin/sh -c apt install nginx' returned a non-zero code: 1
</code></pre></div>
<p>As you can see, the <code>apt install</code> command is asking for permission to continue with the installation. This teaches us an important aspect of containerization: the <code>Dockerfile</code> must contain only commands that run <em>automatically</em>. Let's fix the file:</p>
<div class="highlight"><pre><span></span><code>...
<span class="k">RUN</span> apt install -y nginx
</code></pre></div>
<p>The <code>-y</code> is specific to <code>apt</code> and means that the user wishes to answer <code>yes</code> to everything.</p>
<p>OK, so let's run the build again:</p>
<div class="highlight"><pre><span></span><code>docker build -t mynginx .
</code></pre></div>
<div class="highlight"><pre><span></span><code>...
 ---&gt; 85e4def234e1
Successfully built 85e4def234e1
</code></pre></div>
<p>So, we run our image:</p>
<div class="highlight"><pre><span></span><code>docker run -ti -p <span class="m">80</span>:80 mynginx
</code></pre></div>
<p>The <code>-p</code> flag tells Docker to map the port 80 of the container to the port 80 of the host. This will allow you to access the service on the IP address of your server. However, we didn't tell Docker to run nginx, so we receive a shell and nothing else. Sure enough, we can <em>start</em> nginx manually, but that's not what we want. Before we exit our container let's find out where nginx is located:</p>
<div class="highlight"><pre><span></span><code>which nginx
</code></pre></div>
<p>This will print the full path of the nginx binary which we will need in a moment. Let's exit the container with <kbd>Ctrl</kbd> + <kbd>D</kbd>.</p>
<p>In order to make Docker actually <em>run</em> nginx we need to employ the <code>CMD</code> command in our <code>Dockerfile</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">CMD</span> <span class="p">[</span><span class="s2">"/usr/sbin/nginx"</span><span class="p">]</span>
</code></pre></div>
<h3 id="a_word_about_cmd">A word about <code>CMD</code><a class="headerlink" href="#a_word_about_cmd" title="Permanent link">#</a></h3>
<p>The <code>CMD</code> command has a second form: <code>CMD nginx parameters here</code>. In this form Docker cannot pass the parameters directly to the underlying <a href="https://linux.die.net/man/3/execv">execv</a> call that will ultimately launch the application. <code>execv</code> expects all parameters in a separated list. The binary itself has to be passed as a full path as the first parameter.</p>
<p>To transform the <code>CMD</code> parameter Docker launches a <em>shell</em> in the container, for example Bash. This shell will then parse the parameters and ultimately launch the desired program.</p>
<p>This may seem like a reasonable approach at first, but can cause problems. The first process in a container is responsible for handling <a href="https://man7.org/linux/man-pages/man7/signal.7.html">signals</a>, such as the <code>TERM</code> signal that indicates that a process should stop gracefully. Bash does not do this. Instead, Bash will ignore the signal and Docker will wait for 30 seconds and then forcefully kill the container.</p>
<p>This is the same reason why you need to be careful when running a shell script in your <code>CMD</code>. If you want to do that you must either handle signals correctly, or launch your subsequent program with the <code>exec</code> stanza. The <code>exec</code> stanza <em>replaces</em> the current shell with the new program instead of launching a child process:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nb">set</span> -e

<span class="c1"># Do some initialization here</span>

<span class="nb">exec</span> /usr/sbin/nginx
</code></pre></div>
<p>There is also a second command in Docker called <code>ENTRYPOINT</code>. The <code>ENTRYPOINT</code> command allows you to specify an additional program that acts as a <em>wrapper</em> for <code>CMD</code>. Let's say you have the <code>CMD</code> from above, and you specify the <code>ENTRYPOINT</code> of <code>/init.sh</code>. In this case the full command that will be launched is <code>/init.sh /usr/sbin/nginx</code>. In other words, the contents of <code>CMD</code> are passed to the <code>ENTRYPOINT</code>.</p>
<h3 id="getting_nginx_running">Getting nginx running<a class="headerlink" href="#getting_nginx_running" title="Permanent link">#</a></h3>
<p>Back to the nginx example. If you launch the container you will see that it exits immediately. As mentioned before, the first process in a container has a special role. This special role is not only to handle signals, but also extends to running the container. If the first process exits the container will stop.</p>
<p>In our case, nginx is doing something called <em>daemonization</em>. Daemonization on Linux means that a process launches a second copy of itself and exits from the first copy in order to give back control over the console to the user. In a container we want exactly the opposite: we do not want nginx to daemonize. This is achieved by setting the <code>daemon off;</code> parameter in the configuration file, or passing it via the command line:</p>
<div class="highlight"><pre><span></span><code><span class="k">CMD</span> <span class="p">[</span><span class="s2">"/usr/sbin/nginx"</span><span class="p">,</span> <span class="s2">"-g"</span><span class="p">,</span> <span class="s2">"daemon off;"</span><span class="p">]</span>
</code></pre></div>
<p>If you now build and run the container you will see that it stays up and you can access the web service on the IP address of your machine running Docker.</p>
<h3 id="applying_configuration_files">Applying configuration files<a class="headerlink" href="#applying_configuration_files" title="Permanent link">#</a></h3>
<p>Having a container with only nginx in it is not very useful, so let's see how we can put some <em>content</em> on the web server. First, let's figure out where the <em>document root</em> of our web server is. We do this by <em>overriding</em> the <code>CMD</code> for out container and launching a shell in it:</p>
<div class="highlight"><pre><span></span><code>docker run -ti mynginx /bin/bash
</code></pre></div>
<p>This will land us in a shell inside a new container. In the container we can search for the document root:</p>
<div class="highlight"><pre><span></span><code>grep -nr <span class="s1">'root '</span> /etc/nginx <span class="p">|</span> grep -v <span class="s1">'#'</span>
</code></pre></div>
<p>This will give us the following result:</p>
<div class="highlight"><pre><span></span><code><span class="k">/etc/nginx/sites-available/default:41:</span>  <span class="s">root</span> <span class="s">/var/www/html</span><span class="p">;</span>
</code></pre></div>
<p>So, the document root is in <code>/var/www/html</code>. Let's create an <code>index.html</code> file which we will copy to the container in the next step:</p>
<div class="highlight"><pre><span></span><code>&lt;h1&gt;Hello world!&lt;/h1&gt;
</code></pre></div>
<p>Copying files to the container:</p>
<div class="highlight"><pre><span></span><code><span class="k">COPY</span> index.html /var/www/html/index.html
</code></pre></div>
<p>If you rebuild and relaunch the container you will see that the default nginx page is replaced by our <code>Hello world!</code>.</p>
<p>Before we proceed, let's document that our container exposes a service on port 80:</p>
<div class="highlight"><pre><span></span><code><span class="k">EXPOSE</span><span class="s"> 80</span>
</code></pre></div>
<p>This is not strictly necessary and only serves a documentation purpose, but it is nevertheless useful.</p>
<h3 id="building_a_software_in_a_container">Building a software in a container<a class="headerlink" href="#building_a_software_in_a_container" title="Permanent link">#</a></h3>
<p>To summarize: in order to containerize our application we need to install the dependencies of your application (e.g. a web server), then copy your compiled application in your container, and then set your <code>CMD</code> to launch your application.</p>
<p>You also have the option to compile your application inside the container. To avoid creating extremely large containers with the build tools we will use <a href="https://docs.docker.com/develop/develop-images/multistage-build/">multistage builds</a>.</p>
<p>Let's create a very simple Go application in a file called <code>main.go</code>:</p>
<div class="highlight"><pre><span></span><code>package main

import (
    "fmt"
    "log"
    "net/http"
)

func handler(w http.ResponseWriter, r *http.Request) {
    fmt.Fprintf(w, "Hello world!")
}

func main() {
    http.HandleFunc("/", handler)
    log.Fatal(http.ListenAndServe(":8080", nil))
}
</code></pre></div>
<p>This program will launch a simple web server on port 8080. Let's also add a <code>go.mod</code> file to enable Go modules:</p>
<div class="highlight"><pre><span></span><code>module github.com/yourusername/smaple

go 1.14
</code></pre></div>
<p>Let's create a <code>Dockerfile</code> that compiles this application:</p>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span> <span class="s">alpine</span> <span class="k">AS</span> <span class="s">build</span>
<span class="k">RUN</span> apk add --update go
<span class="k">RUN</span> mkdir -p /srv/myapp
<span class="k">WORKDIR</span><span class="s"> /srv/myapp</span>
<span class="k">COPY</span> main.go .
<span class="k">COPY</span> go.mod .
<span class="k">ENV</span> <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span>
<span class="k">RUN</span> go build -tags netgo -a -v main.go
<span class="k">RUN</span> chmod +x main
</code></pre></div>
<p>In the next stage we will copy our compiled application from the first stage and run it:</p>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span> <span class="s">alpine</span> <span class="k">AS</span> <span class="s">run</span>
<span class="k">RUN</span> apk add --no-cache libc6-compat
<span class="k">COPY</span> --from<span class="o">=</span>build /srv/myapp/main /app
<span class="k">CMD</span> <span class="p">[</span><span class="s2">"/app"</span><span class="p">]</span>
<span class="k">EXPOSE</span><span class="s"> 8080</span>
</code></pre></div>
<p>Finally, let's run it:</p>
<div class="highlight"><pre><span></span><code>docker build -t myapp .
docker run -d -p 8080:8080 myapp
</code></pre></div>
<p>There you go! That's your app built and running in a single file. You can see a few additional commands above, feel free to look them up in the <a href="https://docs.docker.com/engine/reference/builder/">official documentation</a>.</p>
<h3 id="service_discovery">Service discovery<a class="headerlink" href="#service_discovery" title="Permanent link">#</a></h3>
<p>Docker has a built-in service discovery model. Containers can address each other by their <em>names</em> as long as you specify the <code>--name</code> parameter when creating or running the container, and the containers are attached to the same network.</p>
<p>Let's take the following example:</p>
<div class="highlight"><pre><span></span><code>docker run --name a -ti ubuntu
docker run --name b -ti ubuntu
docker network create <span class="nb">test</span>
docker network connect <span class="nb">test</span> a
docker network connect <span class="nb">test</span> b
</code></pre></div>
<p>In this case both A and B containers will be able to talk to each other over the network with their respective names. Alternatively, you can also provide the <code>--network</code> option to <code>docker run</code></p>
<h3 id="volumes">Volumes<a class="headerlink" href="#volumes" title="Permanent link">#</a></h3>
<p>One last item we need to talk about are <em>volumes</em>. Containers are designed to be <em>immutable</em>. When a new version comes along we simply destroy the existing container and create a new one. Some services like database, however, need to store data in a persistent fashion. That's what we need volumes for.</p>
<p>In the container world we can mount volumes directly from the host machine, or we can mount a network-based storage as discussed in the lectures. In our example we will showcase how to mount a volume from a local folder using Docker.</p>
<p>Assuming we want to launch a webserver we can mount the document root from our previous example:</p>
<div class="highlight"><pre><span></span><code>docker run -d -p 80:80 -v /srv/www:/var/www/html mynginx
</code></pre></div>
<p>In this case the <code>/srv/www</code> folder of the host machine will be mounted in <code>/var/www/html</code> inside the container. This can be used to persist data, but also during development when files change frequently.</p>
<h3 id="security_hardening">Security hardening<a class="headerlink" href="#security_hardening" title="Permanent link">#</a></h3>
<p>One more aspect of containerization we need to talk about is security. With our configuration above our container is running as root. While the container has a security boundary, running as root can still present a security risk. In fact, enterprise Kubernetes setups like <a href="https://www.openshift.com/">OpenShift</a> do not allow containers to run as root.</p>
<p>Let's change our Go container so it doesn't run as root:</p>
<div class="highlight"><pre><span></span><code>...
<span class="k">FROM</span> <span class="s">alpine</span> <span class="k">AS</span> <span class="s">run</span>
<span class="k">RUN</span> addgroup -S --gid <span class="m">1000</span> app <span class="o">&amp;&amp;</span> adduser -S app --uid <span class="m">1000</span> -G app
<span class="k">COPY</span> --from<span class="o">=</span>build /srv/myapp/main /app
<span class="k">CMD</span> <span class="p">[</span><span class="s2">"/app"</span><span class="p">]</span>
<span class="k">USER</span><span class="s"> 1000:1000</span>
<span class="k">EXPOSE</span><span class="s"> 8080</span>
</code></pre></div>
<p>Note that we are specifying the user ID and group ID to run as in numeric form (<code>1000</code>). The <code>USER</code> command allows user names to be passed as well, but in a hardened Kubernetes setup this will not be accepted.</p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav aria-label="Footer" class="md-footer-nav__inner md-grid">
<a class="md-footer-nav__link md-footer-nav__link--prev" href="../2-terraform/" rel="prev">
<div class="md-footer-nav__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer-nav__title">
<div class="md-ellipsis">
<span class="md-footer-nav__direction">
                  Previous
                </span>
                2. Terraform
              </div>
</div>
</a>
<a class="md-footer-nav__link md-footer-nav__link--next" href="../4-prometheus/" rel="next">
<div class="md-footer-nav__title">
<div class="md-ellipsis">
<span class="md-footer-nav__direction">
                  Next
                </span>
                4. Prometheus
              </div>
</div>
<div class="md-footer-nav__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
            Copyright Â© 2020 Janos Pasztor, Peter Wenzl, GÃ¼nther Pospischil
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
          Material for MkDocs
        </a>
</div>
</div>
</div>
</footer>
</div>
<script src="../../assets/javascripts/vendor.7e0ee788.min.js"></script>
<script src="../../assets/javascripts/bundle.b3a72adc.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
<script>
        app = initialize({
          base: "../..",
          features: ['navigation.tabs'],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
<script src="../../player.js"></script>
<script src="../../external.js"></script>
<script src="../../download.js"></script>
</body>
</html>